<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <title>Page Title</title>
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <link rel="stylesheet" type="text/css" media="screen" href="game.css" />
    <!-- <script src="game.js"></script> -->
</head>
<body>
    <div class="wrapper">
    <div class="player"></div>
    </div>
      <div class="panel">
        <div class="score"></div>
      </div>
    



    <script>
    var player = document.querySelector('.player')
    var playerPositionX = parseInt(window.getComputedStyle(player).getPropertyValue('left'))
    var playerPositionY = parseInt(window.getComputedStyle(player).getPropertyValue('top'));
    var playerRadius = parseInt(window.getComputedStyle(player).getPropertyValue('width'));


    var board = document.querySelector('.wrapper')
    var direction = 0;
    var position = 0;
    var event = 0;
    var meteorSpeed = 0;
    var meteors = [];
    var bullets = [];
    const randomPos = Math.ceil(Math.random() * 910);
    const randomSpeed = Math.ceil(Math.random() * 3);
    var beginAt = Date.now()
    var lastMeteorTime = beginAt;
    var lastBulletTime = beginAt;
    var bulletDTime = 1000
    var meteorDTime = 800 
    var boardHeight = parseInt(window.getComputedStyle(board).getPropertyValue('height'));
    var fire = 0;
    var score = 0;
    var scorePoint = 1;
    var x = 0;
    var y = 0;
// var meteor = null;
// update ();




  update();
  function update() {
    var now = Date.now()
    
    if (now - lastMeteorTime > meteorDTime) {
      createMeteor()
    lastMeteorTime = now
}
    
    meteors.forEach(function (meteor) {
      var top = parseFloat(window.getComputedStyle(meteor).top);
      var left = parseFloat(window.getComputedStyle(meteor).left);
      var playerPositionX = parseInt(window.getComputedStyle(player).getPropertyValue('left'))
      var playerPositionY = parseInt(window.getComputedStyle(player).getPropertyValue('top'));
      
      if (left >= playerPositionX - playerRadius/2 - 15 && left <= playerPositionX + playerRadius/2 + 15 && 
        top >= playerPositionY - playerRadius + 17 ) {
          return
      }
      top += meteor.speed;
      if (top >= 370) {
        meteor.remove()
      }
      

      meteor.style.top = top + 'px';
    })
   
    if (fire > 0 && now - lastBulletTime > bulletDTime) {
      createBullet()
      lastBulletTime = now;
    }

    bullets.forEach( function(bullet){
      var bulletTop = parseFloat(window.getComputedStyle(bullet).top);
      bulletTop += -3
      bullet.style.top = bulletTop + 'px';

      if (bulletTop < 0) {
        bullet.remove();
      }

      var meteory = document.querySelectorAll('.meteor')
      meteory.forEach(function (meteor){
      var top = parseFloat(window.getComputedStyle(meteor).top);
      var left = parseFloat(window.getComputedStyle(meteor).left);
      var bulletPositionX = parseInt(window.getComputedStyle(bullet).getPropertyValue('left'))
      var bulletRadius = parseInt(window.getComputedStyle(bullet).getPropertyValue('width'))
      var bulletTop = parseFloat(window.getComputedStyle(bullet).top);
        
      if (left >= bulletPositionX - bulletRadius/2 - 15 && left <= bulletPositionX + bulletRadius/2 + 15 && 
        top >= bulletTop - bulletRadius + 17 ) {
          meteor.remove()
          bullet.remove()
          getPoint();

      }
          
    })

      

    })

    

  //  moveBackground();
    movePlayer();

    requestAnimationFrame(update);
  }



window.addEventListener('keydown', function(event){
var key = event.code

if (key === 'ArrowRight') {
 direction = 3;
 
}

if (key === 'ArrowLeft') {
    direction = -3;
}

if (key === 'Space') {
  fire = 1;
}
})



window.addEventListener('keyup', function (event){
var key = event.code

if (key === 'ArrowRight') {
    direction = 0;
}
if (key === 'ArrowLeft') {
    direction = 0;
}
if (key === 'Space') {
  fire = 0;
}
})

function getPoint() {
  document.querySelector('.score').innerHTML = (score += scorePoint)

}


function createMeteor() {

    
    var meteor = document.createElement('div')
    meteor.classList.add('meteor')
    meteor.speed = Math.ceil(Math.random() * 3)
    meteor.style.left = Math.random() * 650 + 'px';
    board.appendChild(meteor)
    // meteors.push(meteor)
    meteors.push(meteor);
   

}

function createBullet() {
  var playerPositionX = parseInt(window.getComputedStyle(player).getPropertyValue('left'))
  var bullet = document.createElement('div')
  bullet.classList.add('bullet')
  bullet.speed = 3;
  bullet.style.left = playerPositionX + 'px';
  bullet.style.top = playerPositionY - playerRadius + 'px'
  board.appendChild(bullet)
  bullets.push(bullet)
}

function putMeteorOnBoard(meteor, board) {
meteor.style.left = Math.random() * 650 + 'px';
board.appendChild(meteor)
}

function moveBackground() {

   
  x += 1
   y += 1
    
    console.log(y)

    board.style.backgroundPosition=x+'px '+y+' px'; 

  y = y = 1
  x = x - 1
}


 function kickMeteor(meteor) {
    // setTimeout(function () {
    //   meteors = meteors.filter(function (falling) {
    //     return meteor !== falling;
    //   })
    //   meteor.remove();
    // }, Math.random() * 3000 + 5000);
    // if (meteor.top > board.clientHeight) {
    //     meteor.remove();
    // }
    meteors.push(meteor);
    meteors.sort((a, b) => a.speed - b.speed).forEach(meteor => board.appendChild(meteor));
  }


// showMeteorAfterTime(5000);

  function showMeteorAfterTime(time) {
      
    setTimeout(function () {
      var meteor = createMeteor();
      putMeteorOnBoard(meteor, board);
      kickMeteor(meteor);
      showMeteorAfterTime(Math.random() * 1000);
    }, time);

  }







// setInterval(function(){


function movePlayer() {
    var left = parseFloat(window.getComputedStyle(player).getPropertyValue('left'));
    left += direction
    player.style.left = left + 'px'
    // position += direction
    //   player.style.left = position + 'px';

      if (left < 0 ) {
            player.style.left = 0 + 'px'}

             if (left > 650) {
                player.style.left = 650 + 'px'
            }

            

        }
            


// }, 1)

        



// function update() {

//     function move(direction) {
//         position += direction
//         player.style.marginLeft = position + 'px';
//     }
    

//     console.log(direction)

//     requestAnimationFrame(update);

    </script>
</body>
</html>